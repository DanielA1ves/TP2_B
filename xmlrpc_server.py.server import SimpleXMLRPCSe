from xmlrpc.server import SimpleXMLRPCServer
from lxml import etree
import xmlschema

class XMLRPCHandler:
    def __init__(self, xml_path):
        self.xml_path = xml_path
        self.tree = etree.parse(xml_path)
        self.root = self.tree.getroot()
    
    def execute_xpath(self, xpath_query):
        """Executa uma query XPath no XML"""
        try:
            result = self.root.xpath(xpath_query)
            # Converter resultado para string se for elemento
            if isinstance(result, list):
                return [etree.tostring(item, encoding='unicode') if isinstance(item, etree._Element) else str(item) for item in result]
            return str(result)
        except Exception as e:
            return f"Erro ao executar XPath: {str(e)}"
    
    def execute_xquery(self, xquery_string):
        """Executa uma query XQuery no XML (simulação usando XPath)"""
        try:
            # Para XQuery completo, seria necessário usar uma biblioteca específica
            # Aqui usamos XPath como alternativa simplificada
            result = self.root.xpath(xquery_string)
            if isinstance(result, list):
                return [etree.tostring(item, encoding='unicode') if isinstance(item, etree._Element) else str(item) for item in result]
            return str(result)
        except Exception as e:
            return f"Erro ao executar XQuery: {str(e)}"
    
    def get_all_records(self):
        """Retorna todos os registos do XML"""
        records = self.root.xpath('//record')
        return [etree.tostring(rec, encoding='unicode') for rec in records]
    
    def get_record_by_id(self, record_id):
        """Retorna um registo específico pelo ID"""
        record = self.root.xpath(f'//record[@id="{record_id}"]')
        if record:
            return etree.tostring(record[0], encoding='unicode')
        return "Registo não encontrado"
    
    def count_records(self):
        """Conta o número total de registos"""
        return len(self.root.xpath('//record'))

def start_server(xml_path='house_purchase.xml', host='localhost', port=8000):
    """Inicia o servidor XML-RPC"""
    server = SimpleXMLRPCServer((host, port), allow_none=True)
    handler = XMLRPCHandler(xml_path)
    
    # Registar as funções
    server.register_function(handler.execute_xpath, 'execute_xpath')
    server.register_function(handler.execute_xquery, 'execute_xquery')
    server.register_function(handler.get_all_records, 'get_all_records')
    server.register_function(handler.get_record_by_id, 'get_record_by_id')
    server.register_function(handler.count_records, 'count_records')
    
    print(f"XML-RPC Server a correr em {host}:{port}")
    print(f"A servir ficheiro: {xml_path}")
    print("\nFunções disponíveis:")
    print("  - execute_xpath(query): Executa query XPath")
    print("  - execute_xquery(query): Executa query XQuery")
    print("  - get_all_records(): Retorna todos os registos")
    print("  - get_record_by_id(id): Retorna registo por ID")
    print("  - count_records(): Conta número de registos")
    
    server.serve_forever()

if __name__ == '__main__':
    start_server()